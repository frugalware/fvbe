#!/bin/sh

set -e

. ./fvbe.conf

KERNEL="/boot/vmlinuz"
INITRD="/boot/initrd"

if [ ! -f "$KERNEL" ]; then
	echo "$KERNEL is missing."
	exit 1
fi

if [ ! -f "$INITRD" ]; then
	echo "$INITRD is missing."
	exit 1
fi

if [ "$(id -u)" -ne 0 -a -z "$FAKEROOTKEY" ]; then
	echo "You must run this as root or use fakeroot."
	exit 1
fi

rm -rf $FVBE_ROOT qemu-kernel qemu-initrd

mkdir -p $FVBE_ROOT

cd $FVBE_ROOT

xz -d < "$INITRD" | cpio --extract --preserve-modification-time

install -m 0755 ../bin/init init

find . | cpio --create -R 0:0 -H newc | xz --check=crc32 --lzma2=dict=1MiB > ../qemu-initrd

cd ..

cp "$KERNEL" qemu-kernel

rm -rf $FVBE_ROOT
