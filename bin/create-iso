#!/bin/sh

set -e

. ./fvbe.conf


do_locales()
{
  echo "submenu 'Locales' {"
  for i in $(cat locales); do
  echo "  menuentry '$i' {"
  echo "    set locale=${i}"
  echo "    export locale"
  echo "    configfile /boot/grub/menu.cfg"
  echo "  }"
  done
  echo "}"
}

do_layouts()
{
  echo "submenu 'Keyboard Layouts' {"
  for i in $(cat layouts); do
  echo "  menuentry '$i' {"
  echo "    set layout=${i}"
  echo "    export layout"
  echo "    configfile /boot/grub/menu.cfg"
  echo "  }"
  done
  echo "}"
}

# First, clean up.
rm -rf $FVBE_ROOT fvbe-$FVBE_ISO_RELEASE-$FVBE_ISO_TYPE-$FVBE_ARCH.iso tmp local local.lastupdate sums var

# Create the skeleton directory.
mkdir -p $FVBE_ROOT/{boot/grub/fonts,LiveOS}

# Copy created rootfs.img into LiveOS dir
cp squashfs.img $FVBE_ROOT/LiveOS

# Setup kernel and initrd.
cp vmlinuz $FVBE_ROOT/boot/vmlinuz
cp initrd $FVBE_ROOT/boot/initrd

# Copy background.png into grub dir
cp background.png $FVBE_ROOT/boot/grub

# Collect some grub files that are not automatically handled.
cp unicode.pf2 $FVBE_ROOT/boot/grub/fonts/unicode.pf2
cat > $FVBE_ROOT/boot/grub/menu.cfg << EOF
insmod png
background_image -m stretch /boot/grub/background.png

set color_normal=white/black
set color_highlight=black/white
set menu_color_normal=white/black
set menu_color_highlight=black/white

menuentry 'Frugalware Versatile Bootable Environment' {
  linux /boot/vmlinuz root=live:CDLABEL=FVBE quiet audit=0 locale.LANG=\$locale vconsole.keymap=\$layout vconsole.font=$FVBE_FONT
  initrd /boot/initrd
}
menuentry 'Frugalware Versatile Bootable Environment (RAM)' {
  linux /boot/vmlinuz root=live:CDLABEL=FVBE quiet audit=0 locale.LANG=\$locale vconsole.keymap=\$layout vconsole.font=$FVBE_FONT rd.live.ram=1
  initrd /boot/initrd
}

$(do_locales)
$(do_layouts)
EOF

# Setup grub2 config.
cat > $FVBE_ROOT/boot/grub/grub.cfg << EOF
set locale=$FVBE_LOCALE
export locale
set layout=$FVBE_LAYOUT
export layout

loadfont unicode
insmod all_video
terminal_input console
terminal_output gfxterm

configfile /boot/grub/menu.cfg
EOF

# Create the ISO.
grub-mkrescue -o fvbe-$FVBE_ISO_RELEASE-$FVBE_ISO_TYPE-$FVBE_ARCH.iso $FVBE_ROOT -- -boot_image any partition_offset=16 -volid FVBE

# Delete the root directory.
rm -rf $FVBE_ROOT tmp local local.lastupdate sums var
