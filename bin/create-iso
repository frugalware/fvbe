#!/bin/sh

set -e

. ./fvbe.conf

# First, clean up.
rm -rf $FVBE_ROOT fvbe-$FVBE_ISO_RELEASE-$FVBE_ISO_TYPE-$FVBE_ARCH.iso tmp local local.lastupdate sums var

# Create the skeleton directory.
mkdir -p $FVBE_ROOT/{boot,LiveOS}

# Setup kernel and initrd.
cp vmlinuz $FVBE_ROOT/boot/vmlinuz
cp initrd $FVBE_ROOT/boot/initrd

# Setup squashfs image.
cp squashfs.img $FVBE_ROOT/LiveOS/squashfs.img

# Setup the pacman-g2 package cache.
if [ -n "$FVBE_ISO_PACKAGES" ]; then
  if [ "$FVBE_ROOTFS_REPOSITORY" = "current" ]; then
    FDB=frugalware-current.fdb
    MIRROR="http://ftp.frugalware.org/pub/frugalware/frugalware-current/frugalware-$FVBE_ARCH"
  elif [ "$FVBE_ROOTFS_REPOSITORY" = "stable" ]; then
    FDB=frugalware.fdb
    MIRROR="http://ftp.frugalware.org/pub/frugalware/frugalware-$FVBE_ISO_RELEASE/frugalware-$FVBE_ARCH"
  fi
  mkdir -p $FVBE_ROOT/packages
  while read line; do
    fpm=$(echo $line | cut -f 1 -d ':')
    sum=$(echo $line | cut -f 2 -d ':')
    if [ ! -f "/var/cache/pacman-g2/pkg/$fpm" ]; then
      wget $MIRROR/$fpm -O /var/cache/pacman-g2/pkg/$fpm
    fi
    cp /var/cache/pacman-g2/pkg/$fpm $FVBE_ROOT/packages/$fpm
    echo "$sum  $FVBE_ROOT/packages/$fpm" >> sums
  done << EOF
$(bin/resolvegroups $FVBE_ISO_PACKAGES)
EOF
  sha1sum -c sums
  cp $FDB $FVBE_ROOT/packages/$FDB
  echo $FVBE_ISO_PACKAGES > $FVBE_ROOT/packages/groups
fi

# Delete the root directory.
rm -rf $FVBE_ROOT tmp local local.lastupdate sums var
