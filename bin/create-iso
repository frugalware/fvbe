#!/bin/sh

set -e

. ./fvbe.conf

# Install syslinux bios.
if [ "$FVBE_ARCH" = "i686" -o "$FVBE_ARCH" = "x86_64" ]; then
  ROOT1="$FVBE_ISO_SYSLINUX_ROOT/bios"
  ROOT2="$FVBE_ROOT/boot/syslinux"
  mkdir -p $ROOT2
  cp $ROOT1/isolinux.bin $ROOT2/isolinux.bin
  cp $ROOT1/ldlinux.c32 $ROOT2/ldlinux.c32
  for i in $FVBE_ISO_SYSLINUX_MODULES; do
    cp $ROOT1/$i.c32 $ROOT2/$i.c32
  done

  ARGS+=" -eltorito-boot boot/syslinux/isolinux.bin"
  ARGS+=" -eltorito-catalog boot/syslinux/boot.cat"
  ARGS+=" -no-emul-boot"
  ARGS+=" -boot-load-size 4"
  ARGS+=" -boot-info-table"
  ARGS+=" -isohybrid-mbr $ROOT1/isohdppx.bin"
fi

# Install syslinux efi.
if [ "$FVBE_ARCH" = "i686" -o "$FVBE_ARCH" = "x86_64" ]; then
  case "$FVBE_ARCH" in
  i686)
    EFI="efi32"
    BOOT="bootia32.efi"
    ;;
  x86_64)
    EFI="efi64"
    BOOT="bootx64.efi"
    ;;
  esac
  ROOT1="$FVBE_ISO_SYSLINUX_ROOT/$EFI"
  ROOT2="$FVBE_ROOT/efi/boot"
  mkdir -p $ROOT2
  cp $ROOT1/syslinux.efi $ROOT2/$BOOT
  cp $ROOT1/ldlinux.${EFI/fi/} $ROOT2/ldlinux.${EFI/fi/}
  for i in $FVBE_ISO_SYSLINUX_MODULES; do
    cp $ROOT1/$i.c32 $ROOT2/$i.c32
  done
  mformat -C -f 2880 -L 16 -i $FVBE_ROOT/efi.img ::
  mcopy -s -i $FVBE_ROOT/efi.img $FVBE_ROOT/efi ::/
  rm -rf $FVBE_ROOT/efi
fi

xorrisofs \
  $ARGS \
  -o fvbe-$FVBE_ISO_RELEASE-$FVBE_ISO_TYPE-$FVBE_ARCH.iso \
  $FVBE_ROOT
